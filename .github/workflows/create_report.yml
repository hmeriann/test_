name: Create Report
on:
  workflow_call:
    inputs:
      platform:
        required: true
        type: string
        
env:
  GH_TOKEN: ${{ github.token }}
jobs:
  prepare-result:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repo with the script
        uses: actions/checkout@v4
      - name: Download build failures
        uses: actions/download-artifact@v4
        with:
          pattern: issue_body_${{ inputs.platform }}*
          path: failures
      - name: Download extensions test results
        uses: actions/download-artifact@v4
        with:
          pattern: issue_ext_${{ inputs.platform }}*
          path: ext_failures
      - name: Prepare a result table
        shell: bash
        run: |
          python -m pip install duckdb
          echo "nightly_build,runs_on,version,extension,failed_statement" > result.csv
          cat issue_ext_*/issue_ext_*.txt >> result.csv
          # scripts/prepare_report.py creates res_${{ inputs.platform }}.md file
          python scripts/prepare_report.py result.csv --nightly_build ${{ inputs.platform }}
      - name: Create result file
        shell: bash
        run: |
          cat issue_body*/issue_body*/* > report_${{ inputs.platform }}.md
          cat res_${{ inputs.platform }}.md >> report_${{ inputs.platform }}.md
      - name: Upload result file
        uses: actions/upload-artifact@v4
        with:
          name: report_${{ inputs.platform }}
          path: report_${{ inputs.platform }}.md
